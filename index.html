<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>PowerNV QEMU guest by legoater</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/legoater">View On GitHub</a></li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>PowerNV QEMU guest</h1>
          <p></p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/legoater">legoater</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <p>A year ago, Benjamin Herrenschmidt pushed a QEMU tree on github </p>

<p><a href="https://github.com/ozbenh/qemu/">https://github.com/ozbenh/qemu/</a></p>

<p>adding a new PowerPC platform. PowerNV (as Non-Virtualized) is the
"baremetal" platform using the OPAL firmware. It runs Linux on IBM and
Open Power systems and it can be used as an hypervisor OS, running KVM
guests, or simply as a host OS.</p>

<p>The QEMU tree Benjamin has pushed is mostly used to test  <a href="http://github.com/open-power/skiboot">skiboot</a>, a
component of OPAL, as a part of a regression testsuite. It is also quite useful for distro development, especially when you can't access real hardware to test your code on the host.</p>

<p>Below is a port of this work on a recent version of QEMU adding a couple of new features such as IPMI.</p>

<ul>
<li>
<p>to clone the updated QEMU tree and compile :</p>

<p><a href="https://github.com/legoater/qemu/tree/powernv-ipmi-2.7">https://github.com/legoater/qemu/tree/powernv-ipmi-2.7</a>  (stable branch on 2.7)</p>

<p><a href="https://github.com/legoater/qemu/tree/powernv-ipmi-2.8">https://github.com/legoater/qemu/tree/powernv-ipmi-2.8</a>  (wip branch)</p>
</li>
<li>
<p>for IPMI support, you will need a recent skiboot for the QEMU platform. You can find it here :</p>

<p><a href="https://github.com/open-power/skiboot/">https://github.com/open-power/skiboot/</a></p>

<p>or just download this custom 5.3.0 <a href="http://www.kaod.org/openpower/qemu/skiboot.lid">skiboot.lid</a> file.</p>
</li>
<li>
<p>to boot, get a skiroot kernel and rootfs. You can find them on the OpenPOWER build site :</p>

<p><a href="https://openpower.xyz/job/openpower-op-build/distro=ubuntu,target=palmetto/lastSuccessfulBuild/artifact/images/">https://openpower.xyz/job/openpower-op-build/distro=ubuntu,target=palmetto/lastSuccessfulBuild/artifact/images/</a></p>

<p>or use these <a href="http://www.kaod.org/openpower/qemu/zImage.epapr">zImage.epapr</a> and <a href="http://www.kaod.org/openpower/qemu/rootfs.cpio.xz">rootfs.cpio.xz</a> files.</p>
</li>
<li><p>run with :</p></li>
</ul>

<pre><code>drive=./fedora23-ppc64le.qcow2
qemu-system-ppc64 -m 2G -machine powernv,accel=tcg -cpu POWER8 \
    -device virtio-net,netdev=netdev0,disable-modern=false \
    -netdev user,id=netdev0,hostfwd=::20022-:22,hostname=pnv \
    -device virtio-blk,drive=drive0,disable-modern=false \
    -drive file=${drive},if=none,id=drive0 \
    -device ipmi-bmc-sim,sdrfile=./palmetto-SDR.bin,fruareasize=256,frudatafile=./palmetto-FRU.bin,id=bmc0 \
    -device isa-ipmi-bt,bmc=bmc0,irq=10 \
    -kernel ./zImage.epapr  \
    -initrd ./rootfs.cpio.xz \
    -bios ./skiboot.lid \
    -nographic -nodefaults
</code></pre>

<p>The files <a href="http://www.kaod.org/openpower/qemu/palmetto-SDR.bin">palmetto-SDR.bin</a> and <a href="http://www.kaod.org/openpower/qemu/palmetto-FRU.bin">palmetto-FRU.bin</a> define a Sensor Data Record repository and a Field  Replaceable  Unit inventory for the BMC simulator used in qemu.</p>

<p>NOTE about using virtio:</p>

<p>There's a bug (yet to investigate) that prevents virtio devices to
  guess the endianness of the guest. As a consequence, legacy virtio
  devices are always considered to run big-endian, but the skiroot
  kernel runs little-endian, so the driver will fail.</p>

<p>The solution is to use virtio 1.0 devices because they always run
  little-endian per specification. This is achieved with the
  disable-modern=false property, that can be passed to any instance
  of any virtio device type. It is also possible to pass this property
  to all instances of a given class with:</p>

<pre><code>    -global virtio-blk-pci.disable-modern=false
</code></pre>

<ul>
<li>then just log on : </li>
</ul>

<pre><code>    $ ssh -p 20022 root@localhost

    root@pnv:~# cat /proc/cpuinfo 
    processor   : 0
    cpu : POWER8 (raw), altivec supported
    clock   : 1000.000000MHz
    revision    : 2.0 (pvr 004d 0200)
    timebase    : 512000000
    platform    : PowerNV
    model   : IBM PowerNV (emulated by qemu)
    machine : PowerNV IBM PowerNV (emulated by qemu)
    firmware    : OPAL v3
</code></pre>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
